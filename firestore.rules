rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE SECURITY PHILOSOPHY:
     * 1. Path-Based Ownership: Data is primarily organized under /users/{userId}. Access is strictly 
     *    granted to the owner of that path or designated collaborators.
     * 2. Identity as Truth: All authorization decisions rely on Firebase Authentication (request.auth). 
     *    This addresses the user's concern regarding password security; while Firebase Auth handles 
     *    the login, these rules ensure that an authenticated user can ONLY access data they own.
     * 3. Denormalization for Performance: Authorization-critical IDs (like teacherId and studentId) 
     *    are stored within documents to allow for fast, single-document lookups without cross-collection gets.
     * 4. Admin Override: A dedicated /roles_admin collection identifies super-users who can bypass 
     *    standard ownership restrictions for support and management.
     * 5. Prototyping Flexibility: Rules enforce WHO can access data and relational integrity, 
     *    but do not restrict the specific data types or fields (schema) to allow for rapid iteration.
     */

    // --- Helper Functions ---

    /**
     * @description Checks if the request is from a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user has an entry in the roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Combines ownership check with existence check for updates and deletes.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the UserProfile entity. Users can manage their own profiles.
     * @path /users/{userId}
     * @allow (get) If the user is the owner or an admin.
     * @deny (write) If the userId in the path does not match the authenticated user's UID.
     * @principle Enforces path-based ownership and relational integrity for user profiles.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin();

      /**
       * @description Rules for ClassSchedules within a user's context (Teacher or Student).
       * @path /users/{anyUser}/schedules/{scheduleId}
       * @allow (create) If the teacherId in data matches the auth UID, allowing teachers to populate student schedules.
       * @deny (read) If the auth UID does not match the parent userId in the path.
       * @principle Supports duplicated schedules for optimized listing while maintaining ownership.
       */
      match /schedules/{scheduleId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if (isOwner(userId) || isOwner(request.resource.data.teacherId)) || isAdmin();
        allow update: if (isExistingOwner(userId) || isOwner(resource.data.teacherId)) || isAdmin();
        allow delete: if (isExistingOwner(userId) || isOwner(resource.data.teacherId)) || isAdmin();
      }

      /**
       * @description Rules for ProgressUpdates. Managed primarily by teachers for their students.
       * @path /users/{studentId}/progressUpdates/{updateId}
       * @allow (list) If the student is the path owner.
       * @deny (create) If the sender is not the teacher identified in the document payload.
       * @principle Validates relational integrity by ensuring the teacher writing the update is who they claim to be.
       */
      match /progressUpdates/{updateId} {
        allow get, list: if isOwner(userId) || isAdmin() || (resource != null && isOwner(resource.data.teacherId));
        allow create: if (isOwner(request.resource.data.teacherId) || isAdmin());
        allow update: if (isOwner(resource.data.teacherId) || isAdmin()) && request.resource.data.teacherId == resource.data.teacherId;
        allow delete: if (isOwner(resource.data.teacherId) || isAdmin());
      }
    }

    /**
     * @description Educational resources accessible to all students but only editable by admins.
     * @path /resources/{resourceId}
     * @allow (list) Any authenticated user.
     * @deny (write) Any non-admin user.
     * @principle Public consumption with administrative control.
     */
    match /resources/{resourceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description System-level collection to define admin users.
     * @path /roles_admin/{userId}
     * @allow (get) Any authenticated user (to check status).
     * @deny (write) All users via API; managed via Admin SDK/Console.
     * @principle Protects the integrity of the authorization hierarchy.
     */
    match /roles_admin/{userId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false; 
    }
  }
}